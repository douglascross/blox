!function(a,b){"function"==typeof define&&define.amd?define("BLOX",[],function(){return a.BLOX=b()}):"object"==typeof exports?module.exports=b():a.BLOX=b()}(this,function(){CSG=function(){this.polygons=[]},CSG.fromPolygons=function(a){var b=new CSG;return b.polygons=a,b},CSG.prototype={clone:function(){var a=new CSG;return a.polygons=this.polygons.map(function(a){return a.clone()}),a},toPolygons:function(){return this.polygons},union:function(a){var b=new CSG.Node(this.clone().polygons),c=new CSG.Node(a.clone().polygons);return b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),CSG.fromPolygons(b.allPolygons())},subtract:function(a){var b=new CSG.Node(this.clone().polygons),c=new CSG.Node(a.clone().polygons);return b.invert(),b.clipTo(c),c.clipTo(b),c.invert(),c.clipTo(b),c.invert(),b.build(c.allPolygons()),b.invert(),CSG.fromPolygons(b.allPolygons())},intersect:function(a){var b=new CSG.Node(this.clone().polygons),c=new CSG.Node(a.clone().polygons);return b.invert(),c.clipTo(b),c.invert(),b.clipTo(c),c.clipTo(b),b.build(c.allPolygons()),b.invert(),CSG.fromPolygons(b.allPolygons())},inverse:function(){var a=this.clone();return a.polygons.map(function(a){a.flip()}),a}},CSG.cube=function(a){a=a||{};var b=new CSG.Vector(a.center||[0,0,0]),c=a.radius?a.radius.length?a.radius:[a.radius,a.radius,a.radius]:[1,1,1];return CSG.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map(function(a){return new CSG.Polygon(a[0].map(function(d){var e=new CSG.Vector(b.x+c[0]*(2*!!(1&d)-1),b.y+c[1]*(2*!!(2&d)-1),b.z+c[2]*(2*!!(4&d)-1));return new CSG.Vertex(e,new CSG.Vector(a[1]))}))}))},CSG.sphere=function(a){function b(a,b){a*=2*Math.PI,b*=Math.PI;var f=new CSG.Vector(Math.cos(a)*Math.sin(b),Math.cos(b),Math.sin(a)*Math.sin(b));c.push(new CSG.Vertex(d.plus(f.times(e)),f))}a=a||{};for(var c,d=new CSG.Vector(a.center||[0,0,0]),e=a.radius||1,f=a.slices||16,g=a.stacks||8,h=[],i=0;f>i;i++)for(var j=0;g>j;j++)c=[],b(i/f,j/g),j>0&&b((i+1)/f,j/g),g-1>j&&b((i+1)/f,(j+1)/g),b(i/f,(j+1)/g),h.push(new CSG.Polygon(c));return CSG.fromPolygons(h)},CSG.cylinder=function(a){function b(a,b,d){var g=b*Math.PI*2,i=j.times(Math.cos(g)).plus(k.times(Math.sin(g))),l=c.plus(e.times(a)).plus(i.times(f)),m=i.times(1-Math.abs(d)).plus(h.times(d));return new CSG.Vertex(l,m)}a=a||{};for(var c=new CSG.Vector(a.start||[0,-1,0]),d=new CSG.Vector(a.end||[0,1,0]),e=d.minus(c),f=a.radius||1,g=a.slices||16,h=e.unit(),i=Math.abs(h.y)>.5,j=new CSG.Vector(i,!i,0).cross(h).unit(),k=j.cross(h).unit(),l=new CSG.Vertex(c,h.negated()),m=new CSG.Vertex(d,h.unit()),n=[],o=0;g>o;o++){var p=o/g,q=(o+1)/g;n.push(new CSG.Polygon([l,b(0,p,-1),b(0,q,-1)])),n.push(new CSG.Polygon([b(0,q,0),b(0,p,0),b(1,p,0),b(1,q,0)])),n.push(new CSG.Polygon([m,b(1,q,1),b(1,p,1)]))}return CSG.fromPolygons(n)},CSG.Vector=function(a,b,c){3==arguments.length?(this.x=a,this.y=b,this.z=c):"x"in a?(this.x=a.x,this.y=a.y,this.z=a.z):(this.x=a[0],this.y=a[1],this.z=a[2])},CSG.Vector.prototype={clone:function(){return new CSG.Vector(this.x,this.y,this.z)},negated:function(){return new CSG.Vector(-this.x,-this.y,-this.z)},plus:function(a){return new CSG.Vector(this.x+a.x,this.y+a.y,this.z+a.z)},minus:function(a){return new CSG.Vector(this.x-a.x,this.y-a.y,this.z-a.z)},times:function(a){return new CSG.Vector(this.x*a,this.y*a,this.z*a)},dividedBy:function(a){return new CSG.Vector(this.x/a,this.y/a,this.z/a)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lerp:function(a,b){return this.plus(a.minus(this).times(b))},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.dividedBy(this.length())},cross:function(a){return new CSG.Vector(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)}},CSG.Vertex=function(a,b){this.pos=new CSG.Vector(a),this.normal=new CSG.Vector(b)},CSG.Vertex.prototype={clone:function(){return new CSG.Vertex(this.pos.clone(),this.normal.clone())},flip:function(){this.normal=this.normal.negated()},interpolate:function(a,b){return new CSG.Vertex(this.pos.lerp(a.pos,b),this.normal.lerp(a.normal,b))}},CSG.Plane=function(a,b){this.normal=a,this.w=b},CSG.Plane.EPSILON=1e-5,CSG.Plane.fromPoints=function(a,b,c){var d=b.minus(a).cross(c.minus(a)).unit();return new CSG.Plane(d,d.dot(a))},CSG.Plane.prototype={clone:function(){return new CSG.Plane(this.normal.clone(),this.w)},flip:function(){this.normal=this.normal.negated(),this.w=-this.w},splitPolygon:function(a,b,c,d,e){for(var f=0,g=1,h=2,i=3,j=0,k=[],l=0;l<a.vertices.length;l++){var m=this.normal.dot(a.vertices[l].pos)-this.w,n=m<-CSG.Plane.EPSILON?h:m>CSG.Plane.EPSILON?g:f;j|=n,k.push(n)}switch(j){case f:(this.normal.dot(a.plane.normal)>0?b:c).push(a);break;case g:d.push(a);break;case h:e.push(a);break;case i:for(var o=[],p=[],l=0;l<a.vertices.length;l++){var q=(l+1)%a.vertices.length,r=k[l],s=k[q],t=a.vertices[l],u=a.vertices[q];if(r!=h&&o.push(t),r!=g&&p.push(r!=h?t.clone():t),(r|s)==i){var m=(this.w-this.normal.dot(t.pos))/this.normal.dot(u.pos.minus(t.pos)),v=t.interpolate(u,m);o.push(v),p.push(v.clone())}}o.length>=3&&d.push(new CSG.Polygon(o,a.shared)),p.length>=3&&e.push(new CSG.Polygon(p,a.shared))}}},CSG.Polygon=function(a,b){this.vertices=a,this.shared=b,this.plane=CSG.Plane.fromPoints(a[0].pos,a[1].pos,a[2].pos)},CSG.Polygon.prototype={clone:function(){var a=this.vertices.map(function(a){return a.clone()});return new CSG.Polygon(a,this.shared)},flip:function(){this.vertices.reverse().map(function(a){a.flip()}),this.plane.flip()}},CSG.Node=function(a){this.plane=null,this.front=null,this.back=null,this.polygons=[],a&&this.build(a)},CSG.Node.prototype={clone:function(){var a=new CSG.Node;return a.plane=this.plane&&this.plane.clone(),a.front=this.front&&this.front.clone(),a.back=this.back&&this.back.clone(),a.polygons=this.polygons.map(function(a){return a.clone()}),a},invert:function(){for(var a=0;a<this.polygons.length;a++)this.polygons[a].flip();this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var b=this.front;this.front=this.back,this.back=b},clipPolygons:function(a){if(!this.plane)return a.slice();for(var b=[],c=[],d=0;d<a.length;d++)this.plane.splitPolygon(a[d],b,c,b,c);return this.front&&(b=this.front.clipPolygons(b)),c=this.back?this.back.clipPolygons(c):[],b.concat(c)},clipTo:function(a){this.polygons=a.clipPolygons(this.polygons),this.front&&this.front.clipTo(a),this.back&&this.back.clipTo(a)},allPolygons:function(){var a=this.polygons.slice();return this.front&&(a=a.concat(this.front.allPolygons())),this.back&&(a=a.concat(this.back.allPolygons())),a},build:function(a){if(a.length){this.plane||(this.plane=a[0].plane.clone());for(var b=[],c=[],d=0;d<a.length;d++)this.plane.splitPolygon(a[d],this.polygons,this.polygons,b,c);b.length&&(this.front||(this.front=new CSG.Node),this.front.build(b)),c.length&&(this.back||(this.back=new CSG.Node),this.back.build(c))}}},window.ThreeBSP=function(){var a,b=1e-5,c=0,d=1,e=2,f=3;return a=function(b){var c,d,e,f,g,h,i,j=[];if(b instanceof THREE.Geometry)this.matrix=new THREE.Matrix4;else{if(!(b instanceof THREE.Mesh)){if(b instanceof a.Node)return this.tree=b,this.matrix=new THREE.Matrix4,this;throw"ThreeBSP: Given geometry is unsupported"}b.updateMatrix(),this.matrix=b.matrix.clone(),b=b.geometry}for(c=0,d=b.faces.length;d>c;c++)e=b.faces[c],g=b.faceVertexUvs[0][c],i=new a.Polygon,e instanceof THREE.Face3?(f=b.vertices[e.a],h=g?new THREE.Vector2(g[0].x,g[0].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[0],h),f.applyMatrix4(this.matrix),i.vertices.push(f),f=b.vertices[e.b],h=g?new THREE.Vector2(g[1].x,g[1].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[1],h),f.applyMatrix4(this.matrix),i.vertices.push(f),f=b.vertices[e.c],h=g?new THREE.Vector2(g[2].x,g[2].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[2],h),f.applyMatrix4(this.matrix),i.vertices.push(f)):(f=b.vertices[e.a],h=g?new THREE.Vector2(g[0].x,g[0].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[0],h),f.applyMatrix4(this.matrix),i.vertices.push(f),f=b.vertices[e.b],h=g?new THREE.Vector2(g[1].x,g[1].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[1],h),f.applyMatrix4(this.matrix),i.vertices.push(f),f=b.vertices[e.c],h=g?new THREE.Vector2(g[2].x,g[2].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[2],h),f.applyMatrix4(this.matrix),i.vertices.push(f),f=b.vertices[e.d],h=g?new THREE.Vector2(g[3].x,g[3].y):null,f=new a.Vertex(f.x,f.y,f.z,e.vertexNormals[3],h),f.applyMatrix4(this.matrix),i.vertices.push(f)),i.calculateProperties(),j.push(i);this.tree=new a.Node(j)},a.prototype.subtract=function(b){var c=this.tree.clone(),d=b.tree.clone();return c.invert(),c.clipTo(d),d.clipTo(c),d.invert(),d.clipTo(c),d.invert(),c.build(d.allPolygons()),c.invert(),c=new a(c),c.matrix=this.matrix,c},a.prototype.union=function(b){var c=this.tree.clone(),d=b.tree.clone();return c.clipTo(d),d.clipTo(c),d.invert(),d.clipTo(c),d.invert(),c.build(d.allPolygons()),c=new a(c),c.matrix=this.matrix,c},a.prototype.intersect=function(b){var c=this.tree.clone(),d=b.tree.clone();return c.invert(),d.clipTo(c),d.invert(),c.clipTo(d),d.clipTo(c),c.build(d.allPolygons()),c.invert(),c=new a(c),c.matrix=this.matrix,c},a.prototype.toGeometry=function(){var a,b,c,d,e,f,g,h,i,j,k=(new THREE.Matrix4).getInverse(this.matrix),l=new THREE.Geometry,m=this.tree.allPolygons(),n=m.length,o={};for(a=0;n>a;a++)for(c=m[a],d=c.vertices.length,b=2;d>b;b++)j=[],h=c.vertices[0],j.push(new THREE.Vector2(h.uv.x,h.uv.y)),h=new THREE.Vector3(h.x,h.y,h.z),h.applyMatrix4(k),"undefined"!=typeof o[h.x+","+h.y+","+h.z]?e=o[h.x+","+h.y+","+h.z]:(l.vertices.push(h),e=o[h.x+","+h.y+","+h.z]=l.vertices.length-1),h=c.vertices[b-1],j.push(new THREE.Vector2(h.uv.x,h.uv.y)),h=new THREE.Vector3(h.x,h.y,h.z),h.applyMatrix4(k),"undefined"!=typeof o[h.x+","+h.y+","+h.z]?f=o[h.x+","+h.y+","+h.z]:(l.vertices.push(h),f=o[h.x+","+h.y+","+h.z]=l.vertices.length-1),h=c.vertices[b],j.push(new THREE.Vector2(h.uv.x,h.uv.y)),h=new THREE.Vector3(h.x,h.y,h.z),h.applyMatrix4(k),"undefined"!=typeof o[h.x+","+h.y+","+h.z]?g=o[h.x+","+h.y+","+h.z]:(l.vertices.push(h),g=o[h.x+","+h.y+","+h.z]=l.vertices.length-1),i=new THREE.Face3(e,f,g,new THREE.Vector3(c.normal.x,c.normal.y,c.normal.z)),l.faces.push(i),l.faceVertexUvs[0].push(j);return l},a.prototype.toMesh=function(a){var b=this.toGeometry(),c=new THREE.Mesh(b,a);return c.position.setFromMatrixPosition(this.matrix),c.rotation.setFromRotationMatrix(this.matrix),c},a.Polygon=function(a,b,c){a instanceof Array||(a=[]),this.vertices=a,a.length>0?this.calculateProperties():this.normal=this.w=void 0},a.Polygon.prototype.calculateProperties=function(){var a=this.vertices[0],b=this.vertices[1],c=this.vertices[2];return this.normal=b.clone().subtract(a).cross(c.clone().subtract(a)).normalize(),this.w=this.normal.clone().dot(a),this},a.Polygon.prototype.clone=function(){var b,c,d=new a.Polygon;for(b=0,c=this.vertices.length;c>b;b++)d.vertices.push(this.vertices[b].clone());return d.calculateProperties(),d},a.Polygon.prototype.flip=function(){var a,b=[];for(this.normal.multiplyScalar(-1),this.w*=-1,a=this.vertices.length-1;a>=0;a--)b.push(this.vertices[a]);return this.vertices=b,this},a.Polygon.prototype.classifyVertex=function(a){var f=this.normal.dot(a)-this.w;return-b>f?e:f>b?d:c},a.Polygon.prototype.classifySide=function(a){var b,g,h,i=0,j=0,k=a.vertices.length;for(b=0;k>b;b++)g=a.vertices[b],h=this.classifyVertex(g),h===d?i++:h===e&&j++;return i>0&&0===j?d:0===i&&j>0?e:0===i&&0===j?c:f},a.Polygon.prototype.splitPolygon=function(b,g,h,i,j){var k=this.classifySide(b);if(k===c)(this.normal.dot(b.normal)>0?g:h).push(b);else if(k===d)i.push(b);else if(k===e)j.push(b);else{var l,m,n,o,p,q,r,s,t,u=[],v=[];for(m=0,l=b.vertices.length;l>m;m++)n=(m+1)%l,q=b.vertices[m],r=b.vertices[n],o=this.classifyVertex(q),p=this.classifyVertex(r),o!=e&&u.push(q),o!=d&&v.push(q),(o|p)===f&&(s=(this.w-this.normal.dot(q))/this.normal.dot(r.clone().subtract(q)),t=q.interpolate(r,s),u.push(t),v.push(t));u.length>=3&&i.push(new a.Polygon(u).calculateProperties()),v.length>=3&&j.push(new a.Polygon(v).calculateProperties())}},a.Vertex=function(a,b,c,d,e){this.x=a,this.y=b,this.z=c,this.normal=d||new THREE.Vector3,this.uv=e||new THREE.Vector2},a.Vertex.prototype.clone=function(){return new a.Vertex(this.x,this.y,this.z,this.normal.clone(),this.uv.clone())},a.Vertex.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},a.Vertex.prototype.subtract=function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},a.Vertex.prototype.multiplyScalar=function(a){return this.x*=a,this.y*=a,this.z*=a,this},a.Vertex.prototype.cross=function(a){var b=this.x,c=this.y,d=this.z;return this.x=c*a.z-d*a.y,this.y=d*a.x-b*a.z,this.z=b*a.y-c*a.x,this},a.Vertex.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return this.x/=a,this.y/=a,this.z/=a,this},a.Vertex.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},a.Vertex.prototype.lerp=function(a,b){return this.add(a.clone().subtract(this).multiplyScalar(b)),this.normal.add(a.normal.clone().sub(this.normal).multiplyScalar(b)),this.uv.add(a.uv.clone().sub(this.uv).multiplyScalar(b)),this},a.Vertex.prototype.interpolate=function(a,b){return this.clone().lerp(a,b)},a.Vertex.prototype.applyMatrix4=function(a){var b=this.x,c=this.y,d=this.z,e=a.elements;return this.x=e[0]*b+e[4]*c+e[8]*d+e[12],this.y=e[1]*b+e[5]*c+e[9]*d+e[13],this.z=e[2]*b+e[6]*c+e[10]*d+e[14],this},a.Node=function(b){var c,d,e=[],f=[];if(this.polygons=[],this.front=this.back=void 0,b instanceof Array&&0!==b.length){for(this.divider=b[0].clone(),c=0,d=b.length;d>c;c++)this.divider.splitPolygon(b[c],this.polygons,this.polygons,e,f);e.length>0&&(this.front=new a.Node(e)),f.length>0&&(this.back=new a.Node(f))}},a.Node.isConvex=function(a){var b,c;for(b=0;b<a.length;b++)for(c=0;c<a.length;c++)if(b!==c&&a[b].classifySide(a[c])!==e)return!1;return!0},a.Node.prototype.build=function(b){var c,d,e=[],f=[];for(this.divider||(this.divider=b[0].clone()),c=0,d=b.length;d>c;c++)this.divider.splitPolygon(b[c],this.polygons,this.polygons,e,f);e.length>0&&(this.front||(this.front=new a.Node),this.front.build(e)),f.length>0&&(this.back||(this.back=new a.Node),this.back.build(f))},a.Node.prototype.allPolygons=function(){var a=this.polygons.slice();return this.front&&(a=a.concat(this.front.allPolygons())),this.back&&(a=a.concat(this.back.allPolygons())),a},a.Node.prototype.clone=function(){var b=new a.Node;return b.divider=this.divider.clone(),b.polygons=this.polygons.map(function(a){return a.clone()}),b.front=this.front&&this.front.clone(),b.back=this.back&&this.back.clone(),b},a.Node.prototype.invert=function(){var a,b,c;for(a=0,b=this.polygons.length;b>a;a++)this.polygons[a].flip();return this.divider.flip(),this.front&&this.front.invert(),this.back&&this.back.invert(),c=this.front,this.front=this.back,this.back=c,this},a.Node.prototype.clipPolygons=function(a){var b,c,d,e;if(!this.divider)return a.slice();for(d=[],e=[],b=0,c=a.length;c>b;b++)this.divider.splitPolygon(a[b],d,e,d,e);return this.front&&(d=this.front.clipPolygons(d)),e=this.back?this.back.clipPolygons(e):[],d.concat(e)},a.Node.prototype.clipTo=function(a){this.polygons=a.clipPolygons(this.polygons),this.front&&this.front.clipTo(a),this.back&&this.back.clipTo(a)},a}();var a=new function(){var b=function(a){console.error("BLOX: "+a)};this.toGeometry=function(c){var d;if(c.shape&&(d=({sphere:function(){return new THREE.SphereGeometry(c.radius,32,32)},box:function(){return new THREE.BoxGeometry(c.x,c.y,c.z)}}[c.shape]||function(){b('Shape "'+c.shape+'" not supported, use sphere or box.')})()),c.subtract){var e=[];c.subtract.forEach(function(b){var c=a.toGeometry(b);c&&e.push(new ThreeBSP(c))});var f,g=d?new ThreeBSP(d):null;if(g||(g=e.shift()),e.length){e.forEach(function(a,b){(b||d)&&(f?f.union(a):f=a)});var h=g.subtract(f);d=h.toGeometry()}else d=g?g.toGeometry():d}else c.union;return d&&c.ops&&c.ops.forEach(function(a){if(a.scale&&d.scale.apply(d,a.scale),a.rotate){var b=a.rotate;b[0]&&d.rotateX(b[0]),b[1]&&d.rotateY(b[1]),b[2]&&d.rotateZ(b[2])}a.translate&&d.translate.apply(d,a.translate)}),d}};return a});